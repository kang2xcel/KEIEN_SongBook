<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Song Book</title>
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --text:#111; --muted:#666; --line:#eaeaea;
      --chip:#f3f3f3; --chip2:#efefef; --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; background:var(--bg); color:var(--text); }
    a { color: inherit; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }

    /* Top */
    .topbar{
      position: sticky; top: 0; z-index: 50;
      background: rgba(250,250,250,.85); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbar .wrap{ padding: 14px 18px; }
    h1 { font-size: 22px; margin: 0; letter-spacing: -.2px; }
    .sub { color: var(--muted); font-size: 13px; margin-top: 6px; }

    .controls { display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; align-items: center; }
    .search { flex: 1 1 260px; position: relative; }
    input[type="text"]{
      width: 100%;
      padding: 11px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      font-size: 14px;
      background: #fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      outline: none;
    }
    .btn{
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      user-select:none;
    }
    .btn:hover{ background: #f7f7f7; }
    .btn.primary{ border-color:#111; }
    .pill{ padding: 6px 10px; background: var(--chip); border:1px solid var(--line); border-radius: 999px; font-size: 13px; color:#333; }
    .count { margin: 12px 0 0; color: var(--muted); font-size: 13px; }

    /* Tabs */
    .tabs { display:flex; gap:8px; flex-wrap: wrap; margin: 14px 0 12px; }
    .tab { padding: 8px 10px; border:1px solid var(--line); background: var(--chip); border-radius: 999px; cursor:pointer; font-size: 13px; }
    .tab:hover { background: var(--chip2); }
    .tab.active { background:#111; color:#fff; border-color:#111; }

    /* Index (초성 바로가기) */
    .indexbar{
      display:flex; gap:8px; flex-wrap: wrap;
      margin: 10px 0 16px;
      padding-bottom: 4px;
    }
    .idx{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      font-size: 13px;
      cursor:pointer;
    }
    .idx:hover{ background:#f7f7f7; }
    .idx.disabled{ opacity:.35; cursor: default; }

    /* Sections + Cards */
    .section{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin: 14px 0;
      overflow: hidden;
    }
    .sectionHead{
      display:flex; justify-content: space-between; align-items:center;
      padding: 14px 14px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(#fff, #fbfbfb);
    }
    .sectionTitle{ font-weight: 800; letter-spacing: -.2px; display:flex; align-items:center; gap:10px; }
    .sectionTitle .badge{ display:inline-flex; align-items:center; justify-content:center; width: 34px; height: 34px; border-radius: 12px; background:#111; color:#fff; font-weight: 800; }
    .sectionMeta{ color: var(--muted); font-size: 13px; }
    .cards{ padding: 10px; display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 720px){
      .cards{ grid-template-columns: 1fr 1fr; }
    }
    .card{
      border: 1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      padding: 12px 12px;
      display:flex; justify-content: space-between; gap:10px;
    }
    .title{ font-weight: 800; letter-spacing: -.2px; margin-bottom: 6px; }
    .meta{ display:flex; flex-wrap: wrap; gap:6px; color:#444; font-size: 13px; }
    .chip{ padding: 3px 8px; border:1px solid var(--line); background: var(--chip); border-radius: 999px; font-size: 12px; color:#333; }
    .chip.rec{ border-color:#111; color:#111; background:#fff; font-weight: 700; }
    .actions{ display:flex; align-items:flex-start; gap:10px; }
    .link{ font-size: 13px; color:#111; padding: 6px 10px; border:1px solid var(--line); border-radius: 999px; background:#fff; }
    .link:hover{ background:#f7f7f7; }

    .empty { color: var(--muted); font-size: 14px; padding: 18px; text-align: center; }

    /* Modal */
    .modalBack{
      position: fixed; inset: 0; background: rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; z-index: 100;
      padding: 18px;
    }
    .modal{
      width: min(520px, 100%);
      background: #fff; border: 1px solid var(--line);
      border-radius: 18px; box-shadow: 0 20px 50px rgba(0,0,0,.2);
      overflow:hidden;
    }
    .modalHead{ padding: 14px 14px; border-bottom:1px solid var(--line); display:flex; justify-content: space-between; align-items:center; }
    .modalBody{ padding: 14px; }
    .x{ cursor:pointer; border:1px solid var(--line); background:#fff; border-radius: 12px; padding: 6px 10px; }
    .x:hover{ background:#f7f7f7; }
    .big{ font-size: 18px; font-weight: 900; letter-spacing: -.2px; margin: 0 0 8px; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <h1>Song Book</h1>
      <div class="sub">초성(ㄱ/ㄴ/ㄷ…) 그룹 · 장르 탭 · 추천곡 · 랜덤 뽑기 · 검색</div>

      <div class="controls">
        <div class="search">
          <input id="q" type="text" placeholder="검색: 곡명 / 가수" />
        </div>
        <button class="btn" id="btnRec">추천곡: 전체</button>
        <button class="btn primary" id="btnRandom">랜덤 노래</button>
        <span class="pill" id="pillStatus">장르: 전체</span>
      </div>

      <div class="tabs" id="tabs"></div>
      <div class="indexbar" id="indexbar"></div>
      <div class="count" id="count"></div>
    </div>
  </div>

  <div class="wrap">
    <div id="sections"></div>
  </div>

  <!-- 랜덤 결과 모달 -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div style="font-weight:800;">랜덤 선택</div>
        <button class="x" id="modalClose">닫기</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  let songs = [];
  let currentGenre = "전체";
  let recommendedOnly = false;

  const CHOSEONG = ["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
  const HANGUL_BASE = 0xAC00, HANGUL_END = 0xD7A3;

  function escapeHtml(str) {
    return String(str || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function uniq(arr) { return [...new Set(arr)].filter(Boolean); }

  function getChoseongChar(title){
    const s = (title || "").trim();
    if (!s) return "#";
    const ch = s[0];

    // 한글 음절이면 초성 계산
    const code = ch.charCodeAt(0);
    if (code >= HANGUL_BASE && code <= HANGUL_END){
      const idx = Math.floor((code - HANGUL_BASE) / 588);
      return CHOSEONG[idx] || "#";
    }

    // 이미 초성(ㄱ 등)이면 그대로
    if (CHOSEONG.includes(ch)) return ch;

    // 숫자/영문/기타는 #로 묶기
    if (/[A-Za-z0-9]/.test(ch)) return "#";
    return "#";
  }

  function normalize(text){
    return String(text || "").toLowerCase();
  }

  function filteredSongs(){
    const q = normalize($("q").value.trim());
    return songs.filter(s => {
      if (recommendedOnly && !s.recommended) return false;
      if (currentGenre !== "전체" && s.genre !== currentGenre) return false;
      if (q){
        const hay = normalize(`${s.title||""} ${s.artist||""} ${s.genre||""}`);
        if (!hay.includes(q)) return false;
      }
      return true;
    });
  }

  function groupByChoseong(items){
    const groups = new Map();
    for (const s of items){
      const key = getChoseongChar(s.title);
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(s);
    }

    // 그룹 내 정렬(제목 기준)
    for (const [k, arr] of groups.entries()){
      arr.sort((a,b) => String(a.title||"").localeCompare(String(b.title||""), "ko"));
    }

    // 그룹 순서: ㄱ~ㅎ, 그 외(#)는 마지막
    const orderedKeys = [...groups.keys()].sort((a,b) => {
      const ai = CHOSEONG.indexOf(a);
      const bi = CHOSEONG.indexOf(b);
      if (a === "#") return 1;
      if (b === "#") return -1;
      if (ai === -1 && bi === -1) return a.localeCompare(b,"ko");
      if (ai === -1) return 1;
      if (bi === -1) return -1;
      return ai - bi;
    });

    return orderedKeys.map(k => [k, groups.get(k)]);
  }

  function renderTabs(genres){
    const tabs = $("tabs");
    tabs.innerHTML = "";
    const all = ["전체", ...genres];

    for (const g of all){
      const b = document.createElement("button");
      b.className = "tab" + (g === currentGenre ? " active" : "");
      b.textContent = g;
      b.onclick = () => { currentGenre = g; render(); };
      tabs.appendChild(b);
    }
  }

  function renderIndexbar(grouped){
    const indexbar = $("indexbar");
    indexbar.innerHTML = "";

    // 표시할 인덱스: ㄱ~ㅎ + # (있을 때)
    const available = new Set(grouped.map(([k]) => k));
    const keys = [...CHOSEONG];
    if (available.has("#")) keys.push("#");

    for (const k of keys){
      const b = document.createElement("button");
      b.className = "idx" + (available.has(k) ? "" : " disabled");
      b.textContent = k;
      b.onclick = () => {
        if (!available.has(k)) return;
        const el = document.getElementById("sec-" + encodeURIComponent(k));
        if (el) el.scrollIntoView({ behavior:"smooth", block:"start" });
      };
      indexbar.appendChild(b);
    }
  }

  function cardHtml(s){
    const chips = [
      s.genre ? `<span class="chip">${escapeHtml(s.genre)}</span>` : "",
      s.recommended ? `<span class="chip rec">추천</span>` : "",
      s.artist ? `<span class="chip">${escapeHtml(s.artist)}</span>` : ""
    ].filter(Boolean).join("");

    const link = s.url ? `<a class="link" href="${s.url}" target="_blank" rel="noreferrer">링크</a>` : "";

    return `
      <div class="card">
        <div>
          <div class="title">${escapeHtml(s.title)}</div>
          <div class="meta">${chips}</div>
        </div>
        <div class="actions">${link}</div>
      </div>
    `;
  }

  function render(){
    const items = filteredSongs();

    $("pillStatus").textContent = `장르: ${currentGenre}`;
    $("count").textContent = `표시 중: ${items.length}곡`;
    $("btnRec").textContent = recommendedOnly ? "추천곡: ON" : "추천곡: 전체";

    // 탭 active 갱신
    [...$("tabs").children].forEach(btn => btn.classList.toggle("active", btn.textContent === currentGenre));

    const grouped = groupByChoseong(items);
    renderIndexbar(grouped);

    const container = $("sections");
    if (!items.length){
      container.innerHTML = `<div class="section"><div class="empty">조건에 맞는 노래가 없습니다.</div></div>`;
      return;
    }

    container.innerHTML = grouped.map(([k, arr]) => {
      const id = "sec-" + encodeURIComponent(k);
      return `
        <div class="section" id="${id}">
          <div class="sectionHead">
            <div class="sectionTitle"><span class="badge">${escapeHtml(k)}</span> ${escapeHtml(k)} 그룹</div>
            <div class="sectionMeta">${arr.length}곡</div>
          </div>
          <div class="cards">
            ${arr.map(cardHtml).join("")}
          </div>
        </div>
      `;
    }).join("");
  }

  function openModal(html){
    $("modalBody").innerHTML = html;
    $("modalBack").style.display = "flex";
    $("modalBack").setAttribute("aria-hidden", "false");
  }
  function closeModal(){
    $("modalBack").style.display = "none";
    $("modalBack").setAttribute("aria-hidden", "true");
  }

  $("modalClose").onclick = closeModal;
  $("modalBack").onclick = (e) => { if (e.target === $("modalBack")) closeModal(); };
  window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  $("q").addEventListener("input", render);

  $("btnRec").onclick = () => { recommendedOnly = !recommendedOnly; render(); };

  $("btnRandom").onclick = () => {
    const items = filteredSongs();
    if (!items.length) return openModal(`<div class="muted">현재 조건에 맞는 노래가 없습니다.</div>`);
    const pick = items[Math.floor(Math.random() * items.length)];
    openModal(`
      <div class="big">${escapeHtml(pick.title)}</div>
      <div class="muted" style="margin-bottom:10px;">${escapeHtml(pick.artist || "")}</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
        ${pick.genre ? `<span class="chip">${escapeHtml(pick.genre)}</span>` : ""}
        ${pick.recommended ? `<span class="chip rec">추천</span>` : ""}
      </div>
      ${pick.url ? `<a class="link" href="${pick.url}" target="_blank" rel="noreferrer">링크 열기</a>` : `<div class="muted">링크가 없습니다.</div>`}
    `);
  };

  // songs.json 읽기
  fetch("./songs.json")
    .then(r => r.json())
    .then(data => {
      songs = data;

      // 장르 탭 생성
      const genres = uniq(songs.map(s => s.genre)).sort((a,b)=>String(a).localeCompare(String(b),"ko"));
      renderTabs(genres);

      render();
    })
    .catch(() => {
      $("count").textContent = "songs.json을 불러오지 못했습니다. index.html과 같은 폴더(저장소 루트)에 있는지 확인하세요.";
    });
</script>
</body>
</html>
